import { useState, useEffect, useRef, lazy, Suspense } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from "@/components/ui/form";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Calendar, Clock, MapPin, CreditCard, User, Phone, Mail, CheckCircle, CheckCircle2, Smartphone, QrCode, Camera } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { ProviderWithServices, ServiceWithProvider } from "@shared/schema";
import { format, addDays, setHours, setMinutes, addMinutes } from "date-fns";
import { generateDynamicTimeSlotsForDate, generateTimeSlotsForDate, generateStaffBasedTimeSlots, generateAvailableDatesForProvider } from '@/lib/scheduling';
import Header from "@/components/layout/header";
import { useClientAuth } from "@/hooks/useClientAuth";
import Footer from "@/components/layout/footer";
// Lazy load components to break circular dependencies
const RobustQrScanner = lazy(() => import('@/components/robust-qr-scanner').then(module => ({ default: module.RobustQrScanner })));
const StaffSelectionGrid = lazy(() => import('@/components/staff-selection-grid'));
const ClientBookingTimeGrid = lazy(() => import('@/components/client-booking-time-grid'));
const UpiPayment = lazy(() => import('@/components/upi-payment'));
// Temporarily removed to debug rendering issues
// import DailyBeautyQuote from "@/components/daily-beauty-quote";
// import ActionButtons from "@/components/action-buttons";

// Create dynamic schema based on authentication status
const createBookingSchema = (isAuthenticated: boolean) => z.object({
  providerId: z.string().min(1, "Please select a provider"),
  selectedServices: z.array(z.string()).min(1, "Please select at least one service"), // Multiple services
  appointmentDate: z.string().min(1, "Please select a date"),
  appointmentTime: z.string().min(1, "Please select a time"),
  staffMemberId: z.string().optional(), // Make staff selection optional
  clientName: isAuthenticated ? z.string().optional() : z.string().min(2, "Name must be at least 2 characters"),
  clientPhone: isAuthenticated ? z.string().optional() : z.string().min(10, "Please enter a valid phone number"),
  notes: z.string().optional(),
  paymentMethod: z.string().min(1, "Please select a payment method"),
  customerUpiId: z.string().optional(),
  transactionId: z.string().optional(),
  providerUpiId: z.string().optional(),
});

// Create a type that covers both authenticated and non-authenticated cases
type BookingFormData = {
  providerId: string;
  selectedServices: string[];
  appointmentDate: string;
  appointmentTime: string;
  staffMemberId?: string;
  clientName?: string;
  clientPhone?: string;
  notes?: string;
  paymentMethod: string;
  customerUpiId?: string;
  transactionId?: string;
  providerUpiId?: string;
};

// Utility functions now imported from @/lib/scheduling

export default function Booking() {
  const [location] = useLocation();
  const queryParams = new URLSearchParams(location.split('?')[1] || '');
  const providerId = queryParams.get('providerId') || queryParams.get('provider'); // Support both parameter names
  const serviceId = queryParams.get('serviceId') || queryParams.get('service'); // Support both parameter names
  
  const [selectedServices, setSelectedServices] = useState<any[]>([]);
  const [bookingStep, setBookingStep] = useState<'details' | 'payment' | 'confirmation'>('details');
  const [bookingId, setBookingId] = useState<string | null>(null);
  const [showQrScanner, setShowQrScanner] = useState(false);
  const [paymentStatus, setPaymentStatus] = useState<'pending' | 'processing' | 'completed' | 'failed'>('pending');
  const [paymentVerified, setPaymentVerified] = useState(false);
  const [showCardForm, setShowCardForm] = useState(false);
  const [cardDetails, setCardDetails] = useState({
    cardNumber: '',
    expiryDate: '',
    cvv: '',
    cardholderName: ''
  });
  
  // SMS notification tracking state
  const [smsStatus, setSmsStatus] = useState<{
    clientSms: 'pending' | 'sending' | 'sent' | 'failed';
    providerSms: 'pending' | 'sending' | 'sent' | 'failed';
    allSent: boolean;
  }>({
    clientSms: 'pending',
    providerSms: 'pending',
    allSent: false
  });
  const [bookingConfirmed, setBookingConfirmed] = useState(false);
  const [bookedSlots, setBookedSlots] = useState<string[]>([]);
  
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const { client, isAuthenticated } = useClientAuth();
  
  // Ref for auto-scrolling to booking details after slot selection
  const bookingDetailsRef = useRef<HTMLDivElement>(null);

  const form = useForm<BookingFormData>({
    resolver: zodResolver(createBookingSchema(isAuthenticated)),
    defaultValues: {
      providerId: providerId || "",
      selectedServices: serviceId ? [serviceId] : [], // Multiple services
      appointmentDate: "",
      appointmentTime: "",
      staffMemberId: "default", // Default staff member
      clientName: isAuthenticated && client ? `${client.title} ${client.firstName} ${client.lastName}` : "",
      clientPhone: isAuthenticated && client ? client.phone : "",
      notes: "",
      paymentMethod: "cash", // Default to "Pay at Appointment"
      customerUpiId: "",
      transactionId: undefined,
      providerUpiId: "",
    },
    mode: "onChange", // Enable real-time validation and updates
  });

  // Use the selectedProviderId from form state which is actually working
  const selectedProviderId = form.watch("providerId");

  // Set providerId in form when URL parameter is available
  useEffect(() => {
    if (providerId && !selectedProviderId) {
      form.setValue('providerId', providerId);
    }
  }, [providerId, selectedProviderId, form]);
  
  // Fetch provider data using the selectedProviderId that's actually working
  const { data: provider, isLoading: providerLoading, error: providerError } = useQuery<ProviderWithServices>({
    queryKey: ["/api/providers", selectedProviderId || providerId],
    enabled: !!(selectedProviderId || providerId),
  });

  // Log provider data when it changes
  useEffect(() => {
    if (provider) {
      console.log('üè™ Provider data loaded:', provider);
      console.log('üí≥ Provider UPI ID:', provider?.upiId);
      console.log('üè¨ Provider merchant name:', provider?.merchantName);
      console.log('üè¢ Provider business name:', provider?.businessName);
    }
  }, [provider]);

  console.log('üîç Provider Query Debug:');
  console.log('  - Raw location:', location);
  console.log('  - Query string:', location.split('?')[1]);
  console.log('  - All query params:', Object.fromEntries(queryParams.entries()));
  console.log('  - providerId:', providerId);
  console.log('  - Query enabled:', !!providerId);
  console.log('  - Provider loading:', providerLoading);
  console.log('  - Provider error:', providerError);
  console.log('  - Provider data:', provider);

  // Fetch all providers for selection
  const { data: allProviders, isLoading: allProvidersLoading, error: allProvidersError } = useQuery<ProviderWithServices[]>({
    queryKey: ["/api/providers"],
    enabled: !providerId,
  });

  // Debug all providers query
  console.log('üè™ All Providers Query Debug:');
  console.log('  - Query enabled:', !providerId);
  console.log('  - Loading:', allProvidersLoading);
  console.log('  - Error:', allProvidersError);
  console.log('  - All providers data:', allProviders);
  console.log('  - All providers count:', allProviders?.length || 0);

  // Fetch global services (new system)
  const { data: globalServices } = useQuery({
    queryKey: ["/api/global-services"],
  });

  const { data: providerServices = [] } = useQuery({
    queryKey: [`/api/providers/${selectedProviderId}/services`],
    enabled: !!selectedProviderId,
  });

  // Fetch provider's schedule when provider is selected
  const { data: providerSchedules = [] } = useQuery({
    queryKey: [`/api/schedules/${selectedProviderId}`],
    enabled: !!selectedProviderId,
  });

  // Fetch staff members for the selected provider
  const { data: staffMembers = [] } = useQuery({
    queryKey: [`/api/staff-members/${selectedProviderId}`],
    enabled: !!selectedProviderId,
  });

  // Fetch existing bookings for selected provider (for conflict detection)
  const selectedDate = form.watch("appointmentDate");
  const { data: existingBookings = [], refetch: refetchBookings } = useQuery({
    queryKey: [`/api/bookings/provider/${selectedProviderId}`],
    enabled: !!selectedProviderId,
    refetchInterval: 30000, // Refresh every 30 seconds for real-time updates
    refetchOnWindowFocus: true, // Refresh when user focuses window
    staleTime: 0, // Always consider data stale for immediate updates
  });

  // Fetch availability slots for selected provider and date (for slot display)
  const serviceDurationForQuery = getSelectedServiceDuration();
  const availabilityQueryKey = [`/api/availability/provider/${selectedProviderId}/date/${selectedDate}?serviceDuration=${serviceDurationForQuery}`];
  
  // üî¥ CRITICAL DEBUG: Track availability API calls
  console.log('üîç AVAILABILITY API DEBUG:', {
    selectedProviderId,
    selectedDate,
    serviceDurationForQuery,
    queryEnabled: !!selectedProviderId && !!selectedDate && serviceDurationForQuery > 0,
    fullUrl: `/api/availability/provider/${selectedProviderId}/date/${selectedDate}?serviceDuration=${serviceDurationForQuery}`
  });
  
  const { data: availabilitySlotsResponse, refetch: refetchAvailability, isFetching, isLoading, error } = useQuery({
    queryKey: availabilityQueryKey,
    enabled: !!selectedProviderId && !!selectedDate && serviceDurationForQuery > 0,
    refetchInterval: 30000, // Refresh every 30 seconds for real-time updates
    refetchOnWindowFocus: true, // Refresh when user focuses window
    staleTime: 0, // Always consider data stale for immediate updates
  });
  
  // Log query status
  console.log('üîç AVAILABILITY QUERY STATUS:', {
    isFetching,
    isLoading,
    hasData: !!availabilitySlotsResponse,
    error: error?.message
  });

  // Extract availability slots from response
  const availabilitySlots: any[] = (availabilitySlotsResponse as any)?.availableSlots || [];

  const services = globalServices || [];
  const availableDates = selectedProviderId ? generateAvailableDatesForProvider(providerSchedules as any[]) : [];
  
  // Helper function to check if a time slot has passed
  const isTimeSlotPassed = (timeString: string, dateString: string) => {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    
    // Only check for passed slots if we're viewing today's date
    if (dateString !== today) {
      return false;
    }
    
    const [hours, minutes] = timeString.split(':').map(Number);
    const slotTime = new Date();
    slotTime.setHours(hours, minutes, 0, 0);
    
    // Check if the slot time has passed
    return slotTime < now;
  };

  // Helper function to get selected service duration
  function getSelectedServiceDuration() {
    const selectedServiceIds = form.watch("selectedServices") || [];
    
    if (!selectedServiceIds || selectedServiceIds.length === 0) {
      return 30; // Default duration
    }
    
    // Get available services
    const allServices = (services as any[]) || [];
    const providerServiceData = (providerServices as any[]) || [];
    
    let totalDuration = 0;
    const serviceDetails: string[] = [];
    
    selectedServiceIds.forEach((serviceId: string) => {
      // Find the service in available services
      let selectedService = allServices.find((s: any) => s.id === serviceId);
      
      // If not found in global services, check provider-specific services
      if (!selectedService) {
        selectedService = providerServiceData.find((s: any) => s.id === serviceId);
      }
      
      if (selectedService) {
        // Get duration from various possible fields
        const duration = selectedService?.baseDuration || 
                         selectedService?.customDuration || 
                         selectedService?.duration || 
                         selectedService?.time || 
                         30;
        
        totalDuration += duration;
        serviceDetails.push(`${selectedService?.name || selectedService?.serviceName}: ${duration}min`);
      }
    });
    
    console.log('üïê Total selected services duration:', totalDuration, 'minutes for services:', serviceDetails.join(', '));
    return totalDuration;
  }

  // Helper function to check if a time slot conflicts with existing bookings for a specific staff member
  function isSlotConflictedWithPadding(slotTime: string, selectedDate: string, serviceDuration: number, staffId: string) {
    console.log(`üîç Checking slot conflict: ${slotTime} for staff ${staffId}`);
    console.log(`üìã Existing bookings:`, existingBookings);
    
    // Fix: Create consistent datetime objects using string-based time
    const slotDateTime = new Date(`${selectedDate}T${slotTime}:00`);
    const slotEndDateTime = addMinutes(slotDateTime, serviceDuration);
    
    return (existingBookings as any[]).some(booking => {
      // Only check conflicts for the same staff member or if no staff specified (backward compatibility)
      const bookingStaffId = booking.staffMemberId || booking.staffId;
      if (bookingStaffId && bookingStaffId !== staffId) {
        return false; // Different staff member
      }
      
      const bookingDateTime = new Date(booking.appointmentDate);
      
      // Fix: Use string slice comparison instead of toDateString() to avoid timezone issues
      const bookingDateStr = booking.appointmentDate.slice(0, 10); // YYYY-MM-DD
      const selectedDateStr = selectedDate; // Already in YYYY-MM-DD format
      
      console.log(`üìÖ Date comparison: booking ${bookingDateStr} vs selected ${selectedDateStr}`);
      
      if (bookingDateStr !== selectedDateStr) {
        console.log(`‚ùå Different day: ${bookingDateStr} !== ${selectedDateStr}`);
        return false; // Different day
      }
      
      console.log(`‚úÖ Same day match: ${bookingDateStr} === ${selectedDateStr}`);
      
      // Fix: Extract time string directly to avoid timezone conversion issues
      const bookingTimeStr = (booking.appointmentDate?.split('T')[1] || '').slice(0, 5) || booking.time || '';
      
      if (!bookingTimeStr) {
        console.log(`‚ùå No booking time found for booking ${booking.id}`);
        return false;
      }
      
      console.log(`üïê Staff ${staffId}: Slot ${slotTime} vs Booking ${bookingTimeStr}`);
      
      // Create consistent datetime objects using string-based time
      const bookingStartDateTime = new Date(`${selectedDate}T${bookingTimeStr}:00`);
      
      // Get booking duration using enhanced calculation (same as backend)
      let bookingDuration = booking.serviceDuration || 
                            booking.duration || 
                            booking.globalService?.baseDuration || 
                            booking.service?.duration;
      
      // If no duration found, calculate from notes (same logic as backend)
      if (!bookingDuration) {
        try {
          // Parse services from booking notes to calculate total duration
          const notes = booking.notes || '';
          const serviceIds: string[] = [];
          
          // Extract main service from booking
          if (booking.serviceId) {
            serviceIds.push(booking.serviceId);
          }
          
          // Extract additional services from notes
          const additionalMatch = notes.match(/Additional Services: ([\w-,\s]+)/);
          if (additionalMatch) {
            const additionalIds = additionalMatch[1].split(',').map((id: string) => id.trim());
            serviceIds.push(...additionalIds);
          }
          
          // Calculate total duration from all services
          if (serviceIds.length > 0) {
            let totalDuration = 0;
            serviceIds.forEach((serviceId: any) => {
              // Find service in provider services
              const service = (providerServices as any[])?.find(s => s.id === serviceId);
              if (service) {
                totalDuration += service.customDuration || service.time || 0;
              }
            });
            
            if (totalDuration > 0) {
              bookingDuration = totalDuration;
              console.log(`üìÖ Calculated booking duration: ${totalDuration} minutes for booking ${booking.id}`);
            }
          }
        } catch (error) {
          console.log('Duration calculation error:', error);
        }
        
        // Final fallback to 30 minutes
        if (!bookingDuration) {
          bookingDuration = 30;
        }
      }
      const bookingEndDateTime = addMinutes(bookingStartDateTime, bookingDuration);
      
      // Debug the booking duration calculation
      console.log(`üîç Booking duration debug for staff ${staffId}:`);
      console.log(`- Booking ID: ${booking.id}`);
      console.log(`- booking.serviceDuration: ${booking.serviceDuration}`);
      console.log(`- Calculated bookingDuration: ${bookingDuration} minutes`);
      console.log(`- Booking start: ${format(bookingStartDateTime, 'HH:mm')}`);
      console.log(`- Booking end: ${format(bookingEndDateTime, 'HH:mm')}`);
      console.log(`- Slot start: ${format(slotDateTime, 'HH:mm')}`);
      console.log(`- Slot end: ${format(slotEndDateTime, 'HH:mm')}`);
      
      // Check for overlap: two appointments overlap if one starts before the other ends
      const overlap = (slotDateTime < bookingEndDateTime) && (slotEndDateTime > bookingStartDateTime);
      
      console.log(`- Overlap result: ${overlap}`);
      
      if (overlap) {
        const slotEndTimeStr = `${slotEndDateTime.getHours().toString().padStart(2, '0')}:${slotEndDateTime.getMinutes().toString().padStart(2, '0')}`;
        const bookingEndTimeStr = `${bookingEndDateTime.getHours().toString().padStart(2, '0')}:${bookingEndDateTime.getMinutes().toString().padStart(2, '0')}`;
        
        console.log('‚ö†Ô∏è Staff-specific slot conflict detected:');
        console.log('- Staff ID:', staffId);
        console.log('- Proposed slot:', slotTime, 'to', slotEndTimeStr, `(${serviceDuration} min)`);
        console.log('- Existing booking:', bookingTimeStr, 'to', bookingEndTimeStr, `(${bookingDuration} min)`);
        console.log('- Booking staff:', bookingStaffId);
      }
      
      return overlap;
    });
  }

  // üöÄ Use backend availability slots directly - NO CLIENT-SIDE PROCESSING!
  console.log('üöÄ Using backend availability slots directly:', availabilitySlots.length, 'slots available');
  console.log('üìã Backend handles all conflict detection, service duration, and staff availability');
  
  // Add debug logging to verify API call is working
  console.log('üéØ DEBUG: availabilitySlotsResponse structure:', availabilitySlotsResponse);
  console.log('üéØ DEBUG: Selected service duration for query:', getSelectedServiceDuration());
  console.log('üéØ DEBUG: Available slots sample:', availabilitySlots.slice(0, 3));
  
  // Transform backend slots directly for UI display (no conflict checking - backend already did this!)
  const staffTimeSlots: any[] = [];
  
  availabilitySlots.forEach((backendSlot: any) => {
    // Check if slot has passed (only UI concern)
    const isPassed = isTimeSlotPassed(backendSlot.startTime, selectedDate);
    
    // Use backend slot data directly - it already has staff and availability info
    if (backendSlot.staffMemberId) {
      // Backend provided specific staff member for this slot
      staffTimeSlots.push({
        time: backendSlot.startTime,
        staffId: backendSlot.staffMemberId,
        staffName: backendSlot.staffMemberName || 'Staff Member',
        isBooked: false, // Backend only returns available slots
        isPassed: isPassed,
        availableSpots: backendSlot.availableSpots || 1,
        duration: backendSlot.duration,
        endTime: backendSlot.endTime
      });
    } else {
      // Create slots for all available staff at this time
      if (staffMembers && Array.isArray(staffMembers) && staffMembers.length > 0) {
        (staffMembers as any[]).forEach(staffMember => {
          staffTimeSlots.push({
            time: backendSlot.startTime,
            staffId: staffMember.id,
            staffName: staffMember.name,
            isBooked: false, // Backend only returns available slots
            isPassed: isPassed,
            availableSpots: backendSlot.availableSpots || 1,
            duration: backendSlot.duration,
            endTime: backendSlot.endTime
          });
        });
      } else {
        // Default staff fallback
        staffTimeSlots.push({
          time: backendSlot.startTime,
          staffId: 'default',
          staffName: 'Available Staff',
          isBooked: false, // Backend only returns available slots
          isPassed: isPassed,
          availableSpots: backendSlot.availableSpots || 1,
          duration: backendSlot.duration,
          endTime: backendSlot.endTime
        });
      }
    }
  });
  
  console.log('‚úÖ Transformed backend slots for UI:', staffTimeSlots.length, 'total slot-staff combinations');
  
  // Group slots by time for display  
  const groupedTimeSlots = staffTimeSlots.reduce((acc: any, slot: any) => {
    if (!acc[slot.time]) {
      acc[slot.time] = [];
    }
    acc[slot.time].push(slot);
    return acc;
  }, {});

  // Helper function to get the correct price for a service
  const getServicePrice = (serviceId: string, availableServicesData: any[]) => {
    const service = availableServicesData.find((s: any) => s.id === serviceId);
    
    if (service) {
      return parseFloat(service.basePrice || service.customPrice || '0');
    }
    
    return 0;
  };

  // Helper function to check if service is offered by provider
  const isServiceOffered = (serviceId: string) => {
    if (!providerServices || !Array.isArray(providerServices)) return false;
    
    // Check both globalServiceId and direct id match (for simplified service table)
    const providerService = providerServices.find((ps: any) => 
      ps.globalServiceId === serviceId || ps.id === serviceId
    );
    
    return providerService?.isOffered === true || providerService?.isActive === true;
  };

  // Get only the services that the provider offers
  const getAvailableServices = () => {
    if (!selectedProviderId) {
      return Array.isArray(services) ? services : []; // Show all services when no provider is selected
    }
    
    console.log("Provider services data:", providerServices);
    
    // If provider is selected but has no services configured, show message instead of fallback
    if (!providerServices || !Array.isArray(providerServices) || providerServices.length === 0) {
      console.log("No provider services found, showing empty state");
      return [];
    }
    
    // Check if provider services are from simplified service table (they have serviceName)
    const firstService = providerServices[0];
    console.log("First service:", firstService);
    
    if (firstService && firstService.serviceName) {
      console.log("Processing simplified service table services");
      // This is from simplified service table - return the services directly
      const transformedServices = providerServices.map((service: any) => ({
        id: service.id,
        name: service.serviceName,
        basePrice: service.customPrice,
        baseDuration: service.customDuration,
        category: 'general', // Default category for simplified services
        description: service.serviceName,
        isActive: service.isOffered || service.isActive
      }));
      console.log("Transformed services:", transformedServices);
      return transformedServices;
    }
    
    console.log("Processing traditional provider services");
    // Traditional provider services - filter global services by what provider offers
    return Array.isArray(services) ? services.filter((service: any) => isServiceOffered(service.id)) : [];
  };

  useEffect(() => {
    if (serviceId && Array.isArray(services) && services.length > 0) {
      const service = services.find((s: any) => s.id === serviceId);
      if (service) {
        setSelectedServices([service]);
      }
    }
  }, [serviceId, services]);

  // Payment processing mutation for all payment methods
  const processPaymentMutation = useMutation({
    mutationFn: async (paymentData: any) => {
      const response = await fetch("/api/process-payment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(paymentData),
      });
      
      if (!response.ok) {
        throw new Error("Payment processing failed");
      }
      
      return response.json();
    },
    onSuccess: (data) => {
      setPaymentVerified(true);
      setPaymentStatus('completed');
      toast({
        title: "Payment Successful!",
        description: `Payment processed successfully. Transaction ID: ${data.transactionId}`,
      });
    },
    onError: (error: Error) => {
      setPaymentStatus('failed');
      toast({
        title: "Payment Failed",
        description: error.message || "Payment processing failed. Please try again.",
        variant: "destructive",
      });
    },
  });

  // Legacy UPI verification mutation (for manual verification)
  const verifyPaymentMutation = useMutation({
    mutationFn: async (paymentData: { upiId: string; transactionId: string; amount: number }) => {
      const response = await fetch("/api/verify-payment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(paymentData),
      });
      
      if (!response.ok) {
        throw new Error("Payment verification failed");
      }
      
      return response.json();
    },
    onSuccess: (data) => {
      setPaymentVerified(true);
      setPaymentStatus('completed');
      toast({
        title: "Payment Verified!",
        description: "Your payment has been successfully verified.",
      });
    },
    onError: () => {
      setPaymentStatus('failed');
      toast({
        title: "Payment Verification Failed",
        description: "Unable to verify payment. Please check your transaction ID.",
        variant: "destructive",
      });
    },
  });

  const bookingMutation = useMutation({
    mutationFn: async (data: BookingFormData) => {
      // Only allow booking confirmation if payment is verified for UPI payments
      if (data.paymentMethod === 'upi' && !paymentVerified) {
        throw new Error("Please complete payment verification first");
      }

      if (!data.selectedServices || data.selectedServices.length === 0) {
        throw new Error("Please select at least one service");
      }

      const { totalPrice, totalDuration } = calculateTotals();
      
      // For now, we'll book the first service and store the total price
      // In a full implementation, you might want to modify the backend to handle multiple services
      const primaryServiceId = data.selectedServices[0];
      
      const bookingData = {
        ...data,
        globalServiceId: primaryServiceId,
        totalPrice: totalPrice,
        notes: data.notes + (data.selectedServices.length > 1 ? 
          `\n\nAdditional Services: ${data.selectedServices.slice(1).map(id => {
            const service = Array.isArray(services) ? services.find((s: any) => s.id === id) : null;
            return service?.name || id;
          }).join(', ')}` : ''),
        paymentVerified: data.paymentMethod === 'cash' ? true : paymentVerified,
      };

      const response = await fetch("/api/bookings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bookingData),
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        if (response.status === 409) {
          // Double booking conflict
          throw new Error(errorData.error || "This time slot is already booked. Please select a different time.");
        }
        throw new Error(errorData.error || "Booking failed");
      }
      
      return response.json();
    },
    onSuccess: (data) => {
      setBookingId(data.booking.id);
      setBookingStep('confirmation');
      
      // Save user booking data to localStorage for header display
      const formData = form.getValues();
      const currentProvider = provider || allProviders?.find(p => p.id === formData.providerId);
      
      const userBookingData = {
        clientName: formData.clientName,
        clientPhone: formData.clientPhone,
        lastBookingLocation: currentProvider?.location || 'Unknown Location',
        totalBookings: 1 // Start with 1, will be updated by querying existing bookings later
      };
      
      // Store in localStorage for immediate display
      localStorage.setItem('userBookingData', JSON.stringify(userBookingData));
      
      // Start SMS sending process
      setSmsStatus({
        clientSms: 'sending',
        providerSms: 'sending',
        allSent: false
      });
      
      // Check SMS status from backend (with fallback simulation)
      const checkSmsStatus = async () => {
        try {
          // Try to get actual SMS status from backend
          const response = await fetch(`/api/bookings/${data.booking.id}/sms-status`);
          if (response.ok) {
            const smsData = await response.json();
            setSmsStatus({
              clientSms: smsData.clientSms || 'sent',
              providerSms: smsData.providerSms || 'sent',
              allSent: true
            });
          } else {
            // Fallback to simulation for demo
            setTimeout(() => {
              setSmsStatus(prev => ({
                ...prev,
                clientSms: 'sent'
              }));
            }, 1500);
            
            setTimeout(() => {
              setSmsStatus(prev => ({
                ...prev,
                providerSms: 'sent',
                allSent: true
              }));
            }, 2500);
          }
        } catch (error) {
          console.log('Using SMS simulation for demo');
          // Fallback simulation
          setTimeout(() => {
            setSmsStatus(prev => ({
              ...prev,
              clientSms: 'sent'
            }));
          }, 1500);
          
          setTimeout(() => {
            setSmsStatus(prev => ({
              ...prev,
              providerSms: 'sent',
              allSent: true
            }));
          }, 2500);
        }
      };
      
      checkSmsStatus();
      
      // Force immediate refresh of booking data with a small delay to ensure backend is updated
      setTimeout(() => {
        console.log('üîÑ Force invalidating queries after booking success');
        
        // Invalidate with current values (avoid stale closures)
        const currentProviderId = form.getValues('providerId');
        const currentDate = form.getValues('appointmentDate');
        
        // Invalidate both booking and availability queries with correct format
        queryClient.invalidateQueries({ queryKey: [`/api/bookings/provider/${currentProviderId}`] });
        queryClient.invalidateQueries({ queryKey: ["/api/bookings"] });
        queryClient.invalidateQueries({ 
          queryKey: [`/api/availability/provider/${currentProviderId}/date/${currentDate}?serviceDuration=${getSelectedServiceDuration()}`] 
        });
        queryClient.invalidateQueries({ queryKey: [`/api/providers/${currentProviderId}/services`] });
        queryClient.invalidateQueries({ queryKey: [`/api/staff-members/${currentProviderId}`] });
        
        // Force refetch both booking and availability data
        refetchBookings();
        refetchAvailability();
        
        console.log('‚úÖ Booking cache invalidated for:', { currentProviderId, currentDate });
      }, 500); // Small delay to ensure backend processing completes
      
      toast({
        title: "Booking confirmed!",
        description: "Your appointment has been successfully booked. SMS notifications are being sent.",
      });
    },
    onError: (error: Error) => {
      console.error("Booking error:", error);
      
      // Refresh booking data when booking fails due to conflicts
      if (error.message?.includes('already booked')) {
        refetchBookings(); // Force refresh booking data
        refetchAvailability(); // Also refresh availability data
        queryClient.invalidateQueries({ 
          queryKey: [`/api/bookings/provider/${selectedProviderId}`] 
        });
        queryClient.invalidateQueries({ 
          queryKey: [`/api/availability/provider/${selectedProviderId}/date/${selectedDate}?serviceDuration=${getSelectedServiceDuration()}`] 
        });
      }
      
      toast({
        title: "Booking failed",
        description: error.message || "Please try again or contact support.",
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: BookingFormData) => {
    if (bookingStep === 'details') {
      setBookingStep('payment');
    } else if (bookingStep === 'payment') {
      // For UPI payments, only proceed if payment is verified
      if (data.paymentMethod === 'upi' && !paymentVerified) {
        toast({
          title: "Payment Required",
          description: "Please complete the UPI payment before confirming your booking.",
          variant: "destructive"
        });
        return;
      }
      bookingMutation.mutate(data);
    }
  };

  const handleProviderSelect = (providerId: string) => {
    form.setValue('providerId', providerId);
    // Reset service selection when provider changes
    form.setValue('selectedServices', []);
    setSelectedServices([]);
    // Reset staff selection when provider changes
    form.setValue('staffMemberId', '');
  };

  const handleStaffSelect = (staffId: string, staffName: string) => {
    form.setValue('staffMemberId', staffId);
  };

  const handleServiceToggle = (serviceId: string) => {
    const currentServices = form.getValues('selectedServices');
    const availableServicesData = getAvailableServices();
    const service = availableServicesData.find((s: any) => s.id === serviceId);
    
    if (currentServices.includes(serviceId)) {
      // Remove service
      const newServices = currentServices.filter(id => id !== serviceId);
      form.setValue('selectedServices', newServices);
      setSelectedServices(prev => prev.filter(s => s.id !== serviceId));
    } else {
      // Add service
      const newServices = [...currentServices, serviceId];
      form.setValue('selectedServices', newServices);
      if (service) {
        setSelectedServices(prev => [...prev, service]);
      }
    }
  };

  // Calculate total price and duration
  const calculateTotals = () => {
    const currentServiceIds = form.getValues('selectedServices');
    const availableServicesData = getAvailableServices();
    let totalPrice = 0;
    let totalDuration = 0;

    currentServiceIds.forEach(serviceId => {
      const service = availableServicesData.find((s: any) => s.id === serviceId);
      
      if (service) {
        // For simplified service table, use basePrice directly
        const price = parseFloat(service.basePrice || service.customPrice || '0');
        const duration = service.baseDuration || service.customDuration || 0;
        
        totalPrice += price;
        totalDuration += duration;
      }
    });

    return { totalPrice, totalDuration };
  };

  const getServiceDuration = (serviceId: string, availableServicesData: any[]) => {
    const service = availableServicesData.find((s: any) => s.id === serviceId);
    
    if (service) {
      return service.baseDuration || service.customDuration || 0;
    }
    
    return 0;
  };

  // Watch form values for real-time icon updates
  const watchedValues = form.watch();
  const selectedServiceIds = watchedValues.selectedServices || [];
  
  // Store available services for debugging
  const availableServices = getAvailableServices();

  if (bookingStep === 'confirmation' && bookingId) {
    return (
      <div className="min-h-screen bg-gradient-hero salon-equipment-bg pb-20">
        <Header />
        
        {/* Confirmation Content */}
        <div className="bg-white/95 py-8">
          <div className="container mx-auto px-4">
            <div className="max-w-2xl mx-auto">
              <Card className="text-center">
                <CardContent className="pt-6">
                  <CheckCircle className="h-16 w-16 text-green-500 mx-auto mb-4" />
                  <h1 className="text-2xl font-bold text-oceanic-blue mb-2">Booking Confirmed!</h1>
                  <p className="text-gray-600 mb-6">
                    Your appointment has been successfully booked. SMS notifications are being sent.
                  </p>
                  
                  {/* SMS Status Section */}
                  <div className="bg-blue-50 p-4 rounded-lg mb-6">
                    <h3 className="font-semibold mb-4 text-left">üì± SMS Notifications</h3>
                    
                    <div className="space-y-3">
                      {/* Client SMS Status */}
                      <div className="flex items-center justify-between p-3 bg-white rounded-lg">
                        <div className="flex items-center gap-3">
                          <div className={`w-3 h-3 rounded-full ${
                            smsStatus.clientSms === 'sent' ? 'bg-green-500' :
                            smsStatus.clientSms === 'sending' ? 'bg-yellow-500 animate-pulse' : 'bg-gray-300'
                          }`}></div>
                          <span className="text-sm font-medium">SMS to Client</span>
                        </div>
                        <span className={`text-xs px-2 py-1 rounded-full ${
                          smsStatus.clientSms === 'sent' ? 'bg-green-100 text-green-700' :
                          smsStatus.clientSms === 'sending' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'
                        }`}>
                          {smsStatus.clientSms === 'sent' ? '‚úì Sent' :
                           smsStatus.clientSms === 'sending' ? 'Sending...' : 'Pending'}
                        </span>
                      </div>
                      
                      {/* Provider SMS Status */}
                      <div className="flex items-center justify-between p-3 bg-white rounded-lg">
                        <div className="flex items-center gap-3">
                          <div className={`w-3 h-3 rounded-full ${
                            smsStatus.providerSms === 'sent' ? 'bg-green-500' :
                            smsStatus.providerSms === 'sending' ? 'bg-yellow-500 animate-pulse' : 'bg-gray-300'
                          }`}></div>
                          <span className="text-sm font-medium">SMS to Provider</span>
                        </div>
                        <span className={`text-xs px-2 py-1 rounded-full ${
                          smsStatus.providerSms === 'sent' ? 'bg-green-100 text-green-700' :
                          smsStatus.providerSms === 'sending' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'
                        }`}>
                          {smsStatus.providerSms === 'sent' ? '‚úì Sent' :
                           smsStatus.providerSms === 'sending' ? 'Sending...' : 'Pending'}
                        </span>
                      </div>
                    </div>
                    
                    {/* All SMS Sent Confirmation */}
                    {smsStatus.allSent && (
                      <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div className="flex items-center justify-center gap-2 text-green-800">
                          <CheckCircle className="h-5 w-5" />
                          <span className="font-medium">All notifications sent successfully!</span>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div className="bg-blue-50 p-4 rounded-lg mb-6">
                    <h3 className="font-semibold mb-2">Booking Details</h3>
                    <p><strong>Booking ID:</strong> {bookingId}</p>
                    <p><strong>Services:</strong> {form.getValues('selectedServices').length} service(s) selected</p>
                    <p><strong>Total Amount:</strong> ‚Çπ{calculateTotals().totalPrice}</p>
                    <p><strong>Total Duration:</strong> {calculateTotals().totalDuration} minutes</p>
                    <p><strong>Date:</strong> {format(new Date(form.getValues('appointmentDate')), 'PPP')}</p>
                    <p><strong>Time:</strong> {form.getValues('appointmentTime')}</p>
                  </div>

                  <div className="space-y-4">
                    {/* Confirmed Button - appears after SMS sent */}
                    {smsStatus.allSent && !bookingConfirmed && (
                      <Button 
                        onClick={() => setBookingConfirmed(true)}
                        className="bg-green-600 hover:bg-green-700 text-white w-full mb-4"
                        data-testid="button-confirmed"
                      >
                        <CheckCircle className="mr-2 h-5 w-5" />
                        Confirmed
                      </Button>
                    )}
                    
                    {/* Show confirmation message after confirmed button is clicked */}
                    {bookingConfirmed && (
                      <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div className="flex items-center justify-center gap-2 text-green-800">
                          <CheckCircle className="h-6 w-6" />
                          <span className="font-bold text-lg">Booking Fully Confirmed!</span>
                        </div>
                        <p className="text-green-700 text-sm mt-2">
                          Both you and your service provider have been notified via SMS.
                        </p>
                      </div>
                    )}
                    
                    <Button 
                      onClick={() => window.location.href = '/client-dashboard'}
                      className="bg-oceanic-blue hover:bg-light-oceanic w-full"
                    >
                      View My Bookings
                    </Button>
                    <Button 
                      variant="outline" 
                      onClick={() => window.location.href = '/providers'}
                      className="w-full"
                    >
                      Book Another Service
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>
        </div>
        
        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-hero salon-equipment-bg pb-20">
      <Header />
      
      {/* Booking Content */}
      <div className="bg-white/95 py-8">
        <div className="container mx-auto px-4">
          <div className="max-w-4xl mx-auto">
            <div className="mb-8">
            <h1 className="text-3xl font-bold text-oceanic-blue mb-2">Book Your Appointment</h1>
            <p className="text-gray-600">Select your service and preferred time</p>
          </div>

          {/* Progress Steps */}
          <div className="flex items-center justify-center mb-8">
            <div className="flex items-center space-x-4">
              <div className={`flex items-center space-x-2 ${bookingStep === 'details' ? 'text-oceanic-blue' : 'text-gray-400'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${bookingStep === 'details' ? 'bg-oceanic-blue text-white' : 'bg-gray-200'}`}>
                  1
                </div>
                <span>Details</span>
              </div>
              <div className="w-8 h-px bg-gray-300"></div>
              <div className={`flex items-center space-x-2 ${bookingStep === 'payment' ? 'text-oceanic-blue' : 'text-gray-400'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${bookingStep === 'payment' ? 'bg-oceanic-blue text-white' : 'bg-gray-200'}`}>
                  2
                </div>
                <span>Payment</span>
              </div>
              <div className="w-8 h-px bg-gray-300"></div>
              <div className={`flex items-center space-x-2 ${bookingStep === 'confirmation' ? 'text-oceanic-blue' : 'text-gray-400'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${bookingStep === 'confirmation' ? 'bg-oceanic-blue text-white' : 'bg-gray-200'}`}>
                  3
                </div>
                <span>Confirmation</span>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Booking Form */}
            <div className="lg:col-span-2">
              <Card>
                <CardHeader>
                  <CardTitle>
                    {bookingStep === 'details' ? 'Appointment Details' : 'Payment Information'}
                  </CardTitle>
                  <CardDescription>
                    {bookingStep === 'details' 
                      ? 'Choose your service and preferred appointment time'
                      : 'Complete your booking with payment details'
                    }
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                      {bookingStep === 'details' && (
                        <>
                          {/* Provider Selection */}
                          {!providerId && allProviders && (
                            <FormField
                              control={form.control}
                              name="providerId"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="flex items-center gap-2">
                                    Choose Service Provider
                                    {watchedValues.providerId && (
                                      <CheckCircle className="h-4 w-4 text-green-500" />
                                    )}
                                  </FormLabel>
                                  <Select onValueChange={handleProviderSelect} value={field.value}>
                                    <FormControl>
                                      <div className="relative">
                                        <SelectTrigger data-testid="select-provider" className="pr-10">
                                          <SelectValue placeholder="Select a service provider" />
                                        </SelectTrigger>
                                        {watchedValues.providerId && (
                                          <CheckCircle className="absolute right-8 top-1/2 transform -translate-y-1/2 h-4 w-4 text-green-500 pointer-events-none z-10" />
                                        )}
                                      </div>
                                    </FormControl>
                                    <SelectContent className="max-h-[300px]">
                                      <div className="max-h-[280px] overflow-y-auto">
                                        {allProviders && allProviders.length > 0 ? (
                                          allProviders.map((prov) => (
                                            <SelectItem key={prov.id} value={prov.id}>
                                              <div className="flex items-center gap-2">
                                                <div className="flex flex-col">
                                                  <span className="font-medium">{prov.businessName}</span>
                                                  <span className="text-sm text-gray-600">{prov.location}</span>
                                                </div>
                                              </div>
                                            </SelectItem>
                                          ))
                                        ) : (
                                          <div className="p-4 text-center text-gray-500">
                                            <p className="text-sm">No providers available yet.</p>
                                            <p className="text-xs mt-1">Check back later or register as a provider!</p>
                                          </div>
                                        )}
                                      </div>
                                    </SelectContent>
                                  </Select>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          )}

                          {/* Service Provider Information */}
                          {provider && (
                            <div className="space-y-4">
                              <div>
                                <h3 className="text-lg font-semibold text-gray-900 mb-3">Service Provider</h3>
                                <div className="bg-white border border-gray-200 rounded-lg p-4">
                                  <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-3">
                                      <div className="w-12 h-12 bg-oceanic-blue rounded-full flex items-center justify-center">
                                        <User className="h-6 w-6 text-white" />
                                      </div>
                                      <div>
                                        <h4 className="font-semibold text-gray-900">{provider.businessName}</h4>
                                        <div className="flex items-center gap-1 text-sm text-gray-600 mt-1">
                                          <MapPin className="h-3 w-3" />
                                          <span>{provider.location}</span>
                                        </div>
                                      </div>
                                    </div>
                                    <CheckCircle className="h-5 w-5 text-green-500" />
                                  </div>
                                  
                                  {provider.specialties && provider.specialties.length > 0 && (
                                    <div>
                                      <span className="text-sm font-medium text-gray-700">Specialties:</span>
                                      <div className="flex flex-wrap gap-2 mt-2">
                                        {provider.specialties.map((specialty, index) => (
                                          <span key={index} className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-oceanic-blue/10 text-oceanic-blue">
                                            {specialty}
                                          </span>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          )}

                          <FormField
                            control={form.control}
                            name="selectedServices"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2">
                                  Choose Services
                                  {watchedValues.selectedServices && watchedValues.selectedServices.length > 0 && (
                                    <CheckCircle className="h-4 w-4 text-green-500" />
                                  )}
                                  {watchedValues.selectedServices && watchedValues.selectedServices.length > 0 && (
                                    <Badge variant="secondary" className="bg-green-100 text-green-800">
                                      {watchedValues.selectedServices.length} selected
                                    </Badge>
                                  )}
                                </FormLabel>
                                <FormControl>
                                  <div className="space-y-3">
                                    {!selectedProviderId ? (
                                      <div className="p-4 text-center text-gray-400 border border-gray-200 rounded-lg bg-gray-50">
                                        <p className="text-sm">Please select a provider first to see their available services.</p>
                                      </div>
                                    ) : availableServices.length === 0 ? (
                                      <div className="p-6 text-center text-gray-500 border border-gray-200 rounded-lg bg-gray-50">
                                        <div className="mb-3">
                                          <Clock className="h-8 w-8 text-gray-400 mx-auto mb-2" />
                                          <h4 className="font-medium text-gray-700 mb-1">Services Not Configured</h4>
                                        </div>
                                        <p className="text-sm mb-2">This provider hasn't customized their services and pricing yet.</p>
                                        <p className="text-xs text-gray-400">Please try another provider or contact them to set up their services.</p>
                                      </div>
                                    ) : (
                                      <div className="border rounded-lg overflow-hidden bg-white">
                                        <div className="overflow-x-auto">
                                          <table className="w-full border-collapse">
                                            <thead>
                                              <tr className="border-b-2 border-gray-200">
                                                <th className="text-left p-3 font-semibold bg-gray-50">#</th>
                                                <th className="text-left p-3 font-semibold bg-gray-50 min-w-[200px]">Services Provided</th>
                                                <th className="text-left p-3 font-semibold bg-gray-50 min-w-[100px]">Price</th>
                                                <th className="text-left p-3 font-semibold bg-gray-50 min-w-[120px]">Duration</th>
                                                <th className="text-center p-3 font-semibold bg-gray-50 min-w-[80px]">Select</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {availableServices.map((service: any, index) => {
                                                const price = parseFloat(service.basePrice || service.customPrice || '0');
                                                const duration = service.baseDuration || service.customDuration || 0;
                                                const isSelected = watchedValues.selectedServices?.includes(service.id);
                                                
                                                return (
                                                  <tr 
                                                    key={service.id} 
                                                    className={`border-b border-gray-100 cursor-pointer transition-all hover:bg-gray-50 ${
                                                      isSelected ? 'bg-green-50' : ''
                                                    }`}
                                                    onClick={() => handleServiceToggle(service.id)}
                                                    data-testid={`service-row-${service.id}`}
                                                  >
                                                    <td className="p-3 text-gray-500 font-medium">{index + 1}</td>
                                                    <td className="p-3">
                                                      <div className="font-medium text-gray-900">
                                                        {service.name || service.serviceName}
                                                      </div>
                                                      {service.description && service.description !== (service.name || service.serviceName) && (
                                                        <div className="text-sm text-gray-500 mt-1">{service.description}</div>
                                                      )}
                                                    </td>
                                                    <td className="p-3">
                                                      <div className="font-semibold text-gray-900">
                                                        ‚Çπ{price}
                                                      </div>
                                                    </td>
                                                    <td className="p-3">
                                                      <div className="flex items-center gap-1 text-gray-600">
                                                        <Clock className="w-3 h-3" />
                                                        <span>{duration} min</span>
                                                      </div>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                      <div className={`w-5 h-5 rounded border-2 flex items-center justify-center mx-auto transition-colors ${
                                                        isSelected 
                                                          ? 'bg-green-500 border-green-500' 
                                                          : 'border-gray-300 hover:border-green-400'
                                                      }`}>
                                                        {isSelected && (
                                                          <CheckCircle className="w-3 h-3 text-white" />
                                                        )}
                                                      </div>
                                                    </td>
                                                  </tr>
                                                );
                                              })}
                                            </tbody>
                                          </table>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </FormControl>
                                <FormMessage />
                                
                                {/* Total Calculation Display */}
                                {watchedValues.selectedServices && watchedValues.selectedServices.length > 0 && (
                                  <div className="mt-4 p-4 bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg">
                                    <div className="flex items-center justify-between">
                                      <div>
                                        <h4 className="font-semibold text-gray-900">Total Summary</h4>
                                        <p className="text-sm text-gray-600">
                                          {watchedValues.selectedServices.length} service{watchedValues.selectedServices.length > 1 ? 's' : ''} selected
                                        </p>
                                      </div>
                                      <div className="text-right">
                                        <div className="text-2xl font-bold text-green-600">
                                          ‚Çπ{calculateTotals().totalPrice}
                                        </div>
                                        <div className="text-sm text-gray-600 flex items-center gap-1">
                                          <Clock className="w-3 h-3" />
                                          <span>{calculateTotals().totalDuration} minutes total</span>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </FormItem>
                            )}
                          />

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormField
                              control={form.control}
                              name="appointmentDate"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="flex items-center gap-2">
                                    Select Date
                                    {watchedValues.appointmentDate && (
                                      <CheckCircle className="h-4 w-4 text-green-500" />
                                    )}
                                  </FormLabel>
                                  <Select onValueChange={field.onChange} value={field.value}>
                                    <FormControl>
                                      <div className="relative">
                                        <SelectTrigger data-testid="select-date" className="pr-10">
                                          <SelectValue placeholder="Choose date" />
                                        </SelectTrigger>
                                        {watchedValues.appointmentDate && (
                                          <CheckCircle className="absolute right-8 top-1/2 transform -translate-y-1/2 h-4 w-4 text-green-500 pointer-events-none z-10" />
                                        )}
                                      </div>
                                    </FormControl>
                                    <SelectContent>
                                      {!selectedProviderId ? (
                                        <div className="p-3 text-center text-gray-500 text-sm">
                                          Please select a provider first
                                        </div>
                                      ) : availableDates.length === 0 ? (
                                        <div className="p-3 text-center text-gray-500 text-sm">
                                          No available dates - Provider hasn't set up their schedule yet
                                        </div>
                                      ) : (
                                        availableDates.map((date) => (
                                          <SelectItem key={date} value={date}>
                                            {format(new Date(date), 'PPP')}
                                          </SelectItem>
                                        ))
                                      )}
                                    </SelectContent>
                                  </Select>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />

                            <FormField
                              control={form.control}
                              name="appointmentTime"
                              render={({ field }) => {
                                // Get booked times for the selected date
                                const bookedTimes = (existingBookings as any[])
                                  .filter((booking: any) => booking.status !== 'cancelled')
                                  .map((booking: any) => {
                                    const date = new Date(booking.appointmentDate);
                                    return format(date, 'HH:mm');
                                  });

                                return (
                                  <FormItem>
                                    <FormLabel className="flex items-center justify-between gap-2">
                                      <span className="flex items-center gap-2">
                                        Select Time Slot
                                        {watchedValues.appointmentTime && (
                                          <CheckCircle className="h-4 w-4 text-green-500" />
                                        )}
                                      </span>
                                      <div className="flex items-center gap-4 text-xs">
                                        <div className="flex items-center gap-1">
                                          <div className="w-3 h-3 bg-green-100 border border-green-300 rounded"></div>
                                          <span>Available</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                          <div className="w-3 h-3 bg-red-100 border border-red-300 rounded"></div>
                                          <span>Booked</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                          <div className="w-3 h-3 bg-blue-100 border-2 border-blue-500 rounded"></div>
                                          <span>Selected</span>
                                        </div>
                                      </div>
                                    </FormLabel>
                                    <FormControl>
                                      <div className="relative">
                                        {!selectedProviderId ? (
                                          <div className="col-span-full p-4 text-center text-gray-500 text-sm">
                                            Please select a provider first
                                          </div>
                                        ) : !selectedDate ? (
                                          <div className="col-span-full p-4 text-center text-gray-500 text-sm">
                                            Please select a date first
                                          </div>
                                        ) : (
                                          <>
                                            {/* Same-day booking restriction messages */}
                                            {selectedDate && new Date(selectedDate).toDateString() === new Date().toDateString() && Object.keys(groupedTimeSlots).length === 0 && (
                                              <div className="p-4 text-center bg-blue-50 border border-blue-200 rounded-lg mb-4">
                                                <div className="text-sm text-blue-700">
                                                  ‚è∞ Same-day booking: No slots available with 1+ hour advance notice
                                                </div>
                                              </div>
                                            )}
                                            {selectedDate && new Date(selectedDate).toDateString() === new Date().toDateString() && Object.keys(groupedTimeSlots).length > 0 && (
                                              <div className="mb-4 p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 text-center">
                                                ‚è∞ Same-day booking: Only slots 1+ hours from now are shown
                                              </div>
                                            )}
                                            
                                            {/* Enhanced Time Slot Grid */}
                                            <ClientBookingTimeGrid
                                              groupedTimeSlots={groupedTimeSlots}
                                              selectedTime={field.value?.split('|')[0] || ''}
                                              selectedStaffId={form.watch('staffMemberId') || ''}
                                              onTimeSelect={(time) => {
                                                field.onChange(time);
                                                form.setValue('staffMemberId', '');
                                              }}
                                              onStaffSelect={(staffId, staffName, time) => {
                                                const slotValue = `${time}|${staffId}`;
                                                field.onChange(slotValue);
                                                form.setValue('staffMemberId', staffId);
                                                
                                                // Auto-scroll to booking details after slot selection
                                                setTimeout(() => {
                                                  if (bookingDetailsRef.current) {
                                                    bookingDetailsRef.current.scrollIntoView({
                                                      behavior: 'smooth',
                                                      block: 'start',
                                                      inline: 'nearest'
                                                    });
                                                  }
                                                }, 300); // Small delay to ensure DOM updates complete
                                              }}
                                              selectedDate={selectedDate}
                                              onRefresh={() => {
                                                console.log('‚ôªÔ∏è Refreshing booking and availability data...');
                                                refetchBookings();
                                                refetchAvailability();
                                                // Invalidate both booking and availability queries
                                                queryClient.invalidateQueries({ 
                                                  queryKey: [`/api/bookings/provider/${selectedProviderId}`] 
                                                });
                                                queryClient.invalidateQueries({ 
                                                  queryKey: availabilityQueryKey
                                                });
                                              }}
                                            />
                                          </>
                                        )}
                                      </div>
                                    </FormControl>
                                    <FormMessage />
                                    {selectedDate && (
                                      <div className="text-xs text-gray-600 mt-2">
                                        Showing availability for {format(new Date(selectedDate), 'PPP')}
                                      </div>
                                    )}
                                  </FormItem>
                                );
                              }}
                            />
                          </div>

                          <Separator />

                          {/* Booking Details Section - Auto-scroll target */}
                          <div ref={bookingDetailsRef}>
                            {isAuthenticated && client ? (
                              // Show confirmation for registered users
                              <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <div className="flex items-center gap-2 mb-2">
                                  <CheckCircle className="h-5 w-5 text-green-600" />
                                  <h3 className="font-semibold text-green-800">Ready to Book!</h3>
                                </div>
                                <p className="text-green-700 text-sm mb-3">
                                  You're already registered with us. Your booking will be confirmed with these details:
                                </p>
                                <div className="bg-white rounded-lg border border-green-200 p-3 space-y-2">
                                  <div className="flex items-center gap-2">
                                    <User className="h-4 w-4 text-gray-600" />
                                    <span className="text-gray-800 font-medium">
                                      {client.title} {client.firstName} {client.lastName ? client.lastName : ''}
                                    </span>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <Phone className="h-4 w-4 text-gray-600" />
                                    <span className="text-gray-800 font-medium">{client.phone}</span>
                                  </div>
                                </div>
                              </div>
                            ) : (
                              // Show form fields for non-registered users
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                  control={form.control}
                                  name="clientName"
                                  render={({ field }) => (
                                    <FormItem>
                                      <FormLabel className="flex items-center gap-2">
                                        Full Name
                                        {watchedValues.clientName && watchedValues.clientName.length >= 2 && (
                                          <CheckCircle className="h-4 w-4 text-green-500" />
                                        )}
                                      </FormLabel>
                                      <FormControl>
                                        <div className="relative">
                                          <User className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                                          <Input 
                                            {...field} 
                                            placeholder="Your full name"
                                            className="pl-10 pr-10"
                                            data-testid="input-clientName"
                                          />
                                          {watchedValues.clientName && watchedValues.clientName.length >= 2 && (
                                            <CheckCircle className="absolute right-3 top-3 h-4 w-4 text-green-500" />
                                          )}
                                        </div>
                                      </FormControl>
                                      <FormMessage />
                                    </FormItem>
                                  )}
                                />

                                <FormField
                                  control={form.control}
                                  name="clientPhone"
                                  render={({ field }) => (
                                    <FormItem>
                                      <FormLabel className="flex items-center gap-2">
                                        Phone Number
                                        {watchedValues.clientPhone && watchedValues.clientPhone.length >= 10 && (
                                          <CheckCircle className="h-4 w-4 text-green-500" />
                                        )}
                                      </FormLabel>
                                      <FormControl>
                                        <div className="relative">
                                          <Phone className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                                          <Input 
                                            {...field} 
                                            type="tel"
                                            placeholder="(555) 123-4567"
                                            className="pl-10 pr-10"
                                            data-testid="input-clientPhone"
                                          />
                                          {watchedValues.clientPhone && watchedValues.clientPhone.length >= 10 && (
                                            <CheckCircle className="absolute right-3 top-3 h-4 w-4 text-green-500" />
                                          )}
                                        </div>
                                      </FormControl>
                                      <FormMessage />
                                    </FormItem>
                                  )}
                                />
                              </div>
                            )}
                          </div>

                          <FormField
                            control={form.control}
                            name="notes"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2">
                                  Special Requests (Optional)
                                  {watchedValues.notes && watchedValues.notes.length > 0 && (
                                    <CheckCircle className="h-4 w-4 text-green-500" />
                                  )}
                                </FormLabel>
                                <FormControl>
                                  <div className="relative">
                                    <Textarea 
                                      {...field} 
                                      placeholder="Any special requests or notes for your appointment..."
                                      className="resize-none pr-10"
                                      rows={3}
                                      data-testid="textarea-notes"
                                    />
                                    {field.value && field.value.length > 0 && (
                                      <CheckCircle className="absolute right-3 top-3 h-4 w-4 text-green-500" />
                                    )}
                                  </div>
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          {/* Payment and Confirmation Buttons */}
                          <div className="space-y-4 pt-6">
                            {/* Payment Button */}
                            <Button 
                              type="button"
                              onClick={() => setBookingStep('payment')}
                              className="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-4 text-lg font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200"
                              disabled={!form.watch('selectedServices')?.length || !form.watch('appointmentDate') || !form.watch('appointmentTime') || (!isAuthenticated && (!form.watch('clientName') || !form.watch('clientPhone')))}
                            >
                              <CreditCard className="mr-2 h-5 w-5" />
                              Continue to Payment
                            </Button>

                            {/* Confirmation Button */}
                            <Button 
                              type="submit"
                              className="w-full bg-oceanic-blue hover:bg-blue-700 text-white px-6 py-4 text-lg font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200"
                              disabled={!form.watch('selectedServices')?.length || !form.watch('appointmentDate') || !form.watch('appointmentTime') || (!isAuthenticated && (!form.watch('clientName') || !form.watch('clientPhone'))) || bookingMutation.isPending}
                            >
                              <CheckCircle className="mr-2 h-5 w-5" />
                              {bookingMutation.isPending ? 'Confirming...' : 'Confirm Booking'}
                            </Button>
                          </div>
                        </>
                      )}

                      {bookingStep === 'payment' && (
                        <>
                          <FormField
                            control={form.control}
                            name="paymentMethod"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2">
                                  Payment Method
                                  {watchedValues.paymentMethod && (
                                    <CheckCircle className="h-4 w-4 text-green-500" />
                                  )}
                                </FormLabel>
                                <Select onValueChange={field.onChange} value={field.value}>
                                  <FormControl>
                                    <div className="relative">
                                      <SelectTrigger data-testid="select-payment" className="pr-10">
                                        <SelectValue placeholder="Choose payment method" />
                                      </SelectTrigger>
                                      {watchedValues.paymentMethod && (
                                        <CheckCircle className="absolute right-8 top-1/2 transform -translate-y-1/2 h-4 w-4 text-green-500 pointer-events-none z-10" />
                                      )}
                                    </div>
                                  </FormControl>
                                  <SelectContent>
                                    <SelectItem value="cash">Pay at Appointment</SelectItem>
                                    <SelectItem value="upi">Pay with UPI (GPay/PhonePe)</SelectItem>
                                    <SelectItem value="qr-scan">Scan & Pay Now</SelectItem>
                                  </SelectContent>
                                </Select>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          {form.watch('paymentMethod') === 'qr-scan' && (
                            <div className="space-y-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                              <div className="flex items-center gap-2">
                                <QrCode className="h-5 w-5 text-purple-600" />
                                <h4 className="font-medium text-purple-800">Scan & Pay Instantly</h4>
                              </div>
                              
                              {/* Provider Payment Information - Automatically Pre-filled */}
                              <div className="bg-white p-4 rounded-lg border space-y-4">
                                <div className="text-center mb-4">
                                  <h4 className="font-semibold text-gray-800 mb-2">üí∞ Direct Payment to Provider</h4>
                                  <p className="text-sm text-gray-600">Your payment will be credited directly to the provider's account in real-time</p>
                                </div>
                                
                                <div className="bg-green-50 p-3 rounded-lg space-y-2">
                                  <div className="flex items-center justify-between">
                                    <span className="text-sm font-medium text-gray-700">Pay to:</span>
                                    <span className="font-mono text-sm bg-green-100 px-2 py-1 rounded font-semibold">
                                      {provider?.upiId || 'Provider UPI ID'}
                                    </span>
                                  </div>
                                  
                                  <div className="flex items-center justify-between">
                                    <span className="text-sm font-medium text-gray-700">Business:</span>
                                    <span className="text-sm font-medium">{provider?.merchantName || provider?.businessName || 'Business Name'}</span>
                                  </div>
                                  
                                  <div className="flex items-center justify-between">
                                    <span className="text-sm font-medium text-gray-700">Amount:</span>
                                    <span className="text-xl font-bold text-green-600">
                                      ‚Çπ{calculateTotals().totalPrice}
                                    </span>
                                  </div>
                                  
                                  {provider?.bankAccountNumber && (
                                    <div className="pt-2 border-t border-green-200">
                                      <div className="flex items-center justify-between">
                                        <span className="text-xs text-gray-600">Bank Account:</span>
                                        <span className="text-xs font-mono">****{provider.bankAccountNumber.slice(-4)}</span>
                                      </div>
                                      {provider?.ifscCode && (
                                        <div className="flex items-center justify-between">
                                          <span className="text-xs text-gray-600">IFSC:</span>
                                          <span className="text-xs font-mono">{provider.ifscCode}</span>
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                                
                                {/* QR Code Display for Provider */}
                                {provider?.qrCodeData && (
                                  <div className="text-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                                    <h5 className="font-medium text-purple-800 mb-2">Provider's Payment QR Code</h5>
                                    <div className="inline-block p-3 bg-white rounded-lg border">
                                      <img 
                                        src={`data:image/svg+xml;utf8,${encodeURIComponent(provider.qrCodeData)}`} 
                                        alt="Provider Payment QR Code"
                                        className="w-32 h-32 mx-auto"
                                      />
                                    </div>
                                    <p className="text-xs text-purple-600 mt-2">
                                      Scan this QR code with any UPI app to pay directly
                                    </p>
                                  </div>
                                )}
                                
                                <div className="bg-purple-50 p-3 rounded-lg">
                                  <div className="flex items-center gap-2 mb-1">
                                    <div className="w-2 h-2 bg-purple-500 rounded-full"></div>
                                    <span className="text-sm font-medium text-purple-800">Direct QR Payment</span>
                                  </div>
                                  <p className="text-xs text-purple-600 ml-4">
                                    Scan provider's payment QR code and payment goes directly to their account
                                  </p>
                                </div>
                                
                                <div className="space-y-4 text-center">
                                  <div className="space-y-3">
                                    <Button
                                      type="button"
                                      onClick={() => setShowQrScanner(true)}
                                      className="w-full bg-purple-600 hover:bg-purple-700 text-white py-6"
                                      data-testid="button-scan-payment-qr"
                                    >
                                      <Camera className="h-6 w-6 mr-3" />
                                      <div className="text-left">
                                        <div className="font-medium">Scan Payment QR Code</div>
                                        <div className="text-sm opacity-90">Scan provider's QR to pay directly</div>
                                      </div>
                                    </Button>
                                  </div>
                                  
                                  <div className="pt-2">
                                    <div className="text-sm text-purple-600 space-y-2">
                                      <div className="flex items-center gap-2">
                                        <div className="w-5 h-5 rounded-full bg-purple-100 flex items-center justify-center">
                                          <span className="text-xs font-bold text-purple-600">1</span>
                                        </div>
                                        <span>Click "Scan Payment QR Code" above</span>
                                      </div>
                                      <div className="flex items-center gap-2">
                                        <div className="w-5 h-5 rounded-full bg-purple-100 flex items-center justify-center">
                                          <span className="text-xs font-bold text-purple-600">2</span>
                                        </div>
                                        <span>Scan provider's payment QR with your camera</span>
                                      </div>
                                      <div className="flex items-center gap-2">
                                        <div className="w-5 h-5 rounded-full bg-purple-100 flex items-center justify-center">
                                          <span className="text-xs font-bold text-purple-600">3</span>
                                        </div>
                                        <span>Complete payment in your UPI app - money goes directly to provider</span>
                                      </div>
                                    </div>
                                  </div>
                                  
                                  <div className="mt-4 bg-green-50 p-3 rounded-lg border border-green-200">
                                    <div className="flex items-center gap-2 mb-1">
                                      <CheckCircle className="h-4 w-4 text-green-600" />
                                      <span className="text-sm font-medium text-green-800">Ready to Book</span>
                                    </div>
                                    <p className="text-xs text-green-600">
                                      After scanning QR and completing payment, you can confirm your booking
                                    </p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}

                          {form.watch('paymentMethod') === 'upi' && (
                            <div className="space-y-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                              <div className="flex items-center gap-2">
                                <Smartphone className="h-5 w-5 text-blue-600" />
                                <h4 className="font-medium text-blue-800">Pay with UPI Apps</h4>
                              </div>
                              
                              <UpiPayment
                                amount={calculateTotals().totalPrice}
                                merchantName={provider?.merchantName || provider?.businessName || 'BookMyLook Provider'}
                                merchantUpiId={provider?.upiId || undefined}
                                transactionNote={`BookMyLook booking - ${provider?.businessName || 'Service'}`}
                                onPaymentInitiated={(paymentMethod, upiLink) => {
                                  form.setValue('providerUpiId', provider?.upiId || '');
                                  form.setValue('customerUpiId', '');
                                  // Don't automatically verify payment - wait for user confirmation
                                  setPaymentStatus('pending');
                                }}
                                onPaymentCompleted={() => {
                                  setPaymentVerified(true);
                                  setPaymentStatus('completed');
                                  toast({
                                    title: "Payment Verified!",
                                    description: "You can now confirm your booking.",
                                  });
                                }}
                                onQrScanned={() => {
                                  toast({
                                    title: "QR Code Ready",
                                    description: "Scan with your UPI app to complete payment",
                                  });
                                }}
                              />
                              
                              {/* Payment Status Display */}
                              <div className="mt-4 p-4 rounded-lg border">
                                <div className="flex items-center gap-2">
                                  {paymentVerified ? (
                                    <>
                                      <CheckCircle2 className="h-5 w-5 text-green-600" />
                                      <span className="text-green-800 font-medium">Payment Completed</span>
                                    </>
                                  ) : (
                                    <>
                                      <div className="h-5 w-5 border-2 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
                                      <span className="text-orange-800 font-medium">Waiting for Payment</span>
                                    </>
                                  )}
                                </div>
                                {paymentVerified ? (
                                  <p className="text-sm text-green-600 mt-1">
                                    ‚úì Payment verified. You can now confirm your booking.
                                  </p>
                                ) : (
                                  <p className="text-sm text-orange-600 mt-1">
                                    Please complete the UPI payment above to continue with your booking.
                                  </p>
                                )}
                              </div>
                              
                              <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                                <div className="flex items-center gap-2 mb-1">
                                  <CheckCircle className="h-4 w-4 text-green-600" />
                                  <span className="text-sm font-medium text-green-800">Secure & Instant</span>
                                </div>
                                <p className="text-xs text-green-600">
                                  Payment goes directly to provider. No BookMyLook fees deducted.
                                </p>
                              </div>
                            </div>
                          )}

                          {form.watch('paymentMethod') === 'cash' && (
                            <div className="space-y-4 p-4 bg-green-50 rounded-lg border border-green-200">
                              <div className="flex items-center gap-2">
                                <CreditCard className="h-5 w-5 text-green-600" />
                                <h4 className="font-medium text-green-800">Pay at Appointment</h4>
                              </div>
                              
                              <div className="text-center py-6">
                                <CheckCircle className="h-12 w-12 text-green-600 mx-auto mb-3" />
                                <h5 className="font-medium text-green-800 mb-2">Payment Option Selected</h5>
                                <p className="text-sm text-green-600">
                                  You will pay ‚Çπ{calculateTotals().totalPrice} directly to the provider at your appointment.
                                </p>
                              </div>
                              
                              <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <h6 className="font-medium text-blue-800 mb-2">Payment Instructions:</h6>
                                <ul className="text-sm text-blue-700 space-y-1">
                                  <li>‚Ä¢ Cash payment accepted</li>
                                  <li>‚Ä¢ UPI payment available at appointment</li>
                                  <li>‚Ä¢ Card payment may be available (check with provider)</li>
                                </ul>
                              </div>
                            </div>
                          )}
                        </>
                      )}

                      {/* Booking step navigation buttons */}
                      <div className="flex space-x-4 pt-6">
                        {bookingStep === 'payment' && (
                          <>
                            <Button 
                              type="button" 
                              variant="outline" 
                              onClick={() => setBookingStep('details')}
                              className="flex-1"
                            >
                              Back
                            </Button>
                            <Button 
                              type="submit"
                              className={`flex-1 px-6 py-3 text-lg font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 ${
                                watchedValues.paymentMethod && (watchedValues.paymentMethod !== 'upi' || paymentVerified)
                                  ? 'bg-green-600 hover:bg-green-700 text-white ring-2 ring-green-400 ring-opacity-50' 
                                  : 'bg-gray-400 hover:bg-gray-500 text-white'
                              }`}
                              disabled={
                                bookingMutation.isPending || 
                                !watchedValues.paymentMethod || 
                                ((watchedValues.paymentMethod === 'upi' || watchedValues.paymentMethod === 'card') && !paymentVerified)
                              }
                              data-testid="button-confirm-booking"
                            >
                              <CheckCircle className="mr-2 h-5 w-5" />
                              {bookingMutation.isPending ? 'Confirming...' : 
                               (watchedValues.paymentMethod === 'upi' || watchedValues.paymentMethod === 'card') && !paymentVerified ? 'Complete Payment First' :
                               'Confirm Booking'}
                            </Button>
                          </>
                        )}
                        
                        {bookingStep === 'details' && (
                          <Button 
                            type="button"
                            onClick={() => setBookingStep('payment')}
                            className="w-full bg-oceanic-blue hover:bg-blue-700 text-white px-8 py-3 text-lg font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200"
                            disabled={!form.watch('selectedServices')?.length || !form.watch('appointmentDate') || !form.watch('appointmentTime') || !form.watch('clientName') || !form.watch('clientPhone')}
                            data-testid="button-confirm-details"
                          >
                            <CheckCircle className="mr-2 h-5 w-5" />
                            Continue to Payment
                          </Button>
                        )}
                      </div>
                    </form>
                  </Form>
                </CardContent>
              </Card>
            </div>

            {/* Booking Summary Sidebar */}
            <div className="lg:col-span-1">
              <Card className="sticky top-8">
                <CardHeader>
                  <CardTitle>Booking Summary</CardTitle>
                </CardHeader>
                <CardContent>
                  {form.getValues('selectedServices').length > 0 ? (
                    <div className="space-y-4">
                      <div>
                        <h4 className="font-semibold">{form.getValues('selectedServices').length} service(s) selected</h4>
                        <p className="text-sm text-gray-600">Total: ‚Çπ{calculateTotals().totalPrice} for {calculateTotals().totalDuration} minutes</p>
                      </div>
                      
                      <div className="flex items-center space-x-2 text-sm text-gray-600">
                        <Clock className="h-4 w-4" />
                        <span>{calculateTotals().totalDuration} minutes</span>
                      </div>
                      
                      <div className="flex items-center space-x-2 text-sm text-gray-600">
                        <CreditCard className="h-4 w-4" />
                        <span className="font-bold text-lg text-oceanic-blue">
                          ‚Çπ{calculateTotals().totalPrice}
                        </span>
                      </div>

                      {provider && (
                        <>
                          <Separator />
                          <div>
                            <h5 className="font-medium">{provider.businessName}</h5>
                            <div className="flex items-center space-x-2 text-sm text-gray-600 mt-1">
                              <MapPin className="h-4 w-4" />
                              <span>{provider.location}</span>
                            </div>
                          </div>
                        </>
                      )}

                      {form.watch('appointmentDate') && form.watch('appointmentTime') && (
                        <>
                          <Separator />
                          <div>
                            <h5 className="font-medium">Selected Time</h5>
                            <div className="flex items-center space-x-2 text-sm text-gray-600 mt-1">
                              <Calendar className="h-4 w-4" />
                              <span>
                                {format(new Date(form.watch('appointmentDate')), 'PPP')} at {form.watch('appointmentTime')}
                              </span>
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                  ) : (
                    <p className="text-gray-500">Select a service to see details</p>
                  )}
                </CardContent>
              </Card>
            </div>
          </div>
        </div>
      </div>
      
      {/* Robust QR Scanner */}
      <RobustQrScanner
        isOpen={showQrScanner}
        onClose={() => setShowQrScanner(false)}
        amount={calculateTotals().totalPrice}
        serviceName={`${form.getValues('selectedServices').length} service(s) selected`}
        onUpiIdScanned={(upiId: string, businessName?: string) => {
          // When QR is scanned, open UPI app directly for payment
          const amount = calculateTotals().totalPrice;
          const selectedServicesString = form.watch('selectedServices')?.map(id => {
            const service = Array.isArray(availableServices) ? availableServices.find((s: any) => s.id === id) : null;
            return service?.name || service?.serviceName || 'Service';
          }).join(', ') || 'Services';
          
          // Create UPI payment link for direct payment
          const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(businessName || 'Provider')}&am=${amount}&cu=INR&tn=${encodeURIComponent(`Payment for ${selectedServicesString}`)}`;
          
          // Open UPI app directly
          window.location.href = upiLink;
          
          // Mark payment as completed after scanning
          form.setValue('providerUpiId', upiId);
          setPaymentStatus('completed');
          setPaymentVerified(true);
          
          toast({
            title: "Payment Processing",
            description: `Opened UPI app to pay ‚Çπ${amount} directly to ${businessName || upiId}. Complete the payment in your UPI app.`,
          });
        }}
      />
      
      <Footer />
      </div>
    </div>
  );
}
